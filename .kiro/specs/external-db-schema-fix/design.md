# Design Document

## Overview

This design addresses a critical database schema mismatch in the `ExternalPersonnel` JPA entity. The entity currently includes a `personnelNoRaw` field mapped to a `personnel_no_raw` column that does not exist in the external database's `person` table. This causes SQL syntax errors during personnel validation queries, triggering circuit breaker failures and preventing user registration.

The solution involves removing the non-existent column mapping while maintaining backward compatibility through the existing helper methods that derive the personnel number from the `esicno` column.

## Architecture

### Current State
- `ExternalPersonnel` entity has 8 fields, including the problematic `personnelNoRaw`
- Hibernate generates SELECT queries that include `personnel_no_raw` column
- External database queries fail with "Unknown column 'ep1_0.personnel_no_raw'" error
- Circuit breaker opens after 3 failed attempts, blocking all external DB access

### Target State
- `ExternalPersonnel` entity will have 7 fields (removing `personnelNoRaw`)
- Hibernate will generate SELECT queries with only existing columns
- `getPersonnelNo()` method will continue to work by converting `esicno` to String
- All queries will succeed without schema errors

## Components and Interfaces

### Modified Component: ExternalPersonnel Entity

**Location:** `src/main/java/com/bidb/personetakip/model/ExternalPersonnel.java`

**Changes:**
1. Remove the `personnelNoRaw` field and its `@Column` annotation
2. Update `getPersonnelNo()` method to always derive from `esicno`
3. Update `setPersonnelNo()` method to only set `esicno` (parsing String to Long)
4. Keep all other fields unchanged

**Interface Contract:**
```java
// Public methods remain unchanged
public String getPersonnelNo()  // Returns esicno.toString()
public void setPersonnelNo(String personnelNo)  // Parses and sets esicno
public String getTcNo()  // Returns tckiml
public String getFirstName()  // Returns peradi
public String getLastName()  // Returns soyadi
// ... other getters/setters remain the same
```

### Unmodified Components

**ExternalPersonnelRepository:** No changes needed - uses JPA queries that will automatically adapt to entity changes

**RegistrationServiceImpl:** No changes needed - uses entity through public interface methods

**Test Classes:** No changes needed - tests use builder pattern with actual database columns

## Data Models

### ExternalPersonnel Entity (After Fix)

```java
@Entity
@Table(name = "person")
public class ExternalPersonnel {
    @Id
    @Column(name = "esicno")
    private Long esicno;  // Personnel number as Long
    
    @Column(name = "tckiml", length = 11)
    private String tckiml;  // TC number
    
    @Column(name = "peradi", length = 100)
    private String peradi;  // First name
    
    @Column(name = "soyadi", length = 100)
    private String soyadi;  // Last name
    
    @Column(name = "brkodu", length = 20)
    private String brkodu;  // Department code
    
    @Column(name = "unvkod", length = 20)
    private String unvkod;  // Title code
    
    @Column(name = "telefo", length = 20)
    private String telefo;  // Mobile phone
    
    // Helper methods for interface compatibility
    public String getPersonnelNo() {
        return esicno != null ? esicno.toString() : null;
    }
    
    public void setPersonnelNo(String personnelNo) {
        if (personnelNo == null || personnelNo.isBlank()) {
            this.esicno = null;
            return;
        }
        String digitsOnly = personnelNo.replaceAll("\\D+", "");
        try {
            this.esicno = digitsOnly.isEmpty() ? null : Long.parseLong(digitsOnly);
        } catch (NumberFormatException e) {
            this.esicno = null;
        }
    }
}
```

### Database Schema (External - Read Only)

**Table:** `person`
**Database:** `isicil` @ 193.140.136.45

| Column  | Type         | Description              |
|---------|--------------|--------------------------|
| esicno  | BIGINT       | Personnel number (PK)    |
| tckiml  | VARCHAR(11)  | TC ID number             |
| peradi  | VARCHAR(100) | First name               |
| soyadi  | VARCHAR(100) | Last name                |
| brkodu  | VARCHAR(20)  | Department code          |
| unvkod  | VARCHAR(20)  | Title code               |
| telefo  | VARCHAR(20)  | Mobile phone             |

**Note:** The `personnel_no_raw` column does NOT exist in this table.

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Column Mapping Accuracy
*For any* JPA query generated by Hibernate for the ExternalPersonnel entity, the SELECT statement should only reference columns that exist in the external database's person table (esicno, tckiml, peradi, soyadi, brkodu, unvkod, telefo)
**Validates: Requirements 1.1, 1.2**

### Property 2: Personnel Number Derivation
*For any* ExternalPersonnel instance with a non-null esicno value, calling getPersonnelNo() should return the string representation of that esicno value
**Validates: Requirements 1.3, 2.3**

### Property 3: Personnel Number Parsing
*For any* valid numeric string passed to setPersonnelNo(), the esicno field should be set to the parsed Long value
**Validates: Requirements 2.3**

### Property 4: Query Success
*For any* valid TC number and personnel number combination, querying the external database should complete without SQL syntax errors
**Validates: Requirements 1.5, 3.1**

### Property 5: Backward Compatibility
*For any* existing test or service code that uses getPersonnelNo() or setPersonnelNo(), the behavior should remain unchanged after the fix
**Validates: Requirements 2.4**

## Error Handling

### Current Error Flow
1. User submits registration with TC and personnel number
2. RegistrationService calls ExternalPersonnelRepository.findByTcNo()
3. Hibernate generates SQL with `personnel_no_raw` column
4. MySQL returns error: "Unknown column 'ep1_0.personnel_no_raw'"
5. Spring translates to InvalidDataAccessResourceUsageException
6. Circuit breaker counts failure (3 attempts with retry)
7. Circuit breaker opens, blocking all external DB access
8. Fallback method throws ExternalServiceException
9. User sees "External personnel database is temporarily unavailable"

### Fixed Error Flow
1. User submits registration with TC and personnel number
2. RegistrationService calls ExternalPersonnelRepository.findByTcNo()
3. Hibernate generates SQL with only existing columns
4. MySQL executes query successfully
5. If personnel found: return data to user
6. If personnel not found: throw PersonnelNotFoundException with clear message
7. Circuit breaker remains closed (no failures)

### Edge Cases

**Empty/Null Personnel Number:**
- `setPersonnelNo(null)` → sets `esicno = null`
- `setPersonnelNo("")` → sets `esicno = null`
- `setPersonnelNo("   ")` → sets `esicno = null`

**Non-Numeric Personnel Number:**
- `setPersonnelNo("ABC123")` → extracts "123", sets `esicno = 123L`
- `setPersonnelNo("ABC")` → no digits, sets `esicno = null`

**Null esicno:**
- `getPersonnelNo()` when `esicno == null` → returns `null`

## Testing Strategy

### Unit Tests

**Test Class:** `ExternalPersonnelTest` (new)

1. **Test Personnel Number Getter**
   - Given: ExternalPersonnel with esicno = 12345L
   - When: getPersonnelNo() is called
   - Then: returns "12345"

2. **Test Personnel Number Getter with Null**
   - Given: ExternalPersonnel with esicno = null
   - When: getPersonnelNo() is called
   - Then: returns null

3. **Test Personnel Number Setter with Valid Number**
   - Given: ExternalPersonnel instance
   - When: setPersonnelNo("12345") is called
   - Then: esicno is set to 12345L

4. **Test Personnel Number Setter with Alphanumeric**
   - Given: ExternalPersonnel instance
   - When: setPersonnelNo("ABC123XYZ") is called
   - Then: esicno is set to 123L

5. **Test Personnel Number Setter with Null**
   - Given: ExternalPersonnel instance
   - When: setPersonnelNo(null) is called
   - Then: esicno is set to null

6. **Test Personnel Number Setter with Empty String**
   - Given: ExternalPersonnel instance
   - When: setPersonnelNo("") is called
   - Then: esicno is set to null

### Integration Tests

**Test Class:** `RegistrationServiceTest` (existing - verify no changes needed)

1. **Verify Existing Tests Pass**
   - Run all existing tests without modification
   - All tests should pass with the entity fix
   - Tests use builder with actual column names (esicno, tckiml, etc.)

2. **Test External Database Query**
   - Given: Valid TC number and personnel number
   - When: validatePersonnel() is called
   - Then: Query executes without SQL errors
   - And: Personnel data is returned correctly

### Property-Based Tests

**Test Class:** `ExternalPersonnelPropertyTest` (new)

1. **Property Test: Personnel Number Round Trip**
   - For any valid Long value L
   - Create ExternalPersonnel with esicno = L
   - Call getPersonnelNo() to get String S
   - Parse S back to Long
   - Assert: parsed Long equals original L
   - **Validates: Property 2**

2. **Property Test: Setter-Getter Consistency**
   - For any numeric string S
   - Create ExternalPersonnel
   - Call setPersonnelNo(S)
   - Call getPersonnelNo()
   - Assert: returned string contains same digits as S
   - **Validates: Property 3**

### Manual Testing

1. **Test Registration Flow**
   - Start application
   - Navigate to registration page
   - Enter valid TC number: 18548809924
   - Enter valid personnel number: 4035
   - Submit form
   - Verify: No SQL errors in logs
   - Verify: Validation succeeds or fails with appropriate message

2. **Test Circuit Breaker Recovery**
   - Verify circuit breaker is currently open (from previous errors)
   - Deploy fix
   - Wait for circuit breaker half-open state (30 seconds)
   - Attempt registration
   - Verify: Circuit breaker closes after successful query

## Implementation Notes

### Lombok Compatibility
- The entity uses `@Data` annotation which generates getters/setters
- Custom `getPersonnelNo()` and `setPersonnelNo()` methods override Lombok-generated ones
- No changes needed to Lombok configuration

### JPA/Hibernate Behavior
- Removing the field will cause Hibernate to regenerate SQL queries
- No schema migration needed (external DB is read-only)
- No impact on local database schema

### Test Data Compatibility
- Existing tests use `.esicno(12345L)` in builder - no changes needed
- Tests never directly set `personnelNoRaw` field
- All test assertions use `getPersonnelNo()` method - will continue to work

### Rollback Plan
If issues arise after deployment:
1. Revert the entity change (restore `personnelNoRaw` field)
2. Restart application
3. Investigate why external DB schema differs from expectations
4. Consider alternative solutions (e.g., @Transient annotation)
